<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prism Viewer</title>
  <style>
    html,body { height:100%; margin:0; background:#000; }
    #newsFrame { width:100%; height:100%; border:0; display:block; }
    #overlay {
      position:fixed; right:8px; top:8px; z-index:9999;
      background:rgba(0,0,0,0.6); color:#fff; padding:6px 8px; border-radius:6px; font-size:13px;
    }
  </style>
</head>
<body>
  <div id="overlay">상태: <span id="status">연결중...</span></div>
  <iframe id="newsFrame" src="/proxy?url=https://news.naver.com/" allow="autoplay"></iframe>

  <script>
    const SERVER = location.origin;
    const params = new URLSearchParams(location.search);
    const room = params.get('room') || 'default';

    const statusEl = document.getElementById('status');
    const iframe = document.getElementById('newsFrame');

    // WebSocket
    const wsProto = (location.protocol === 'https:') ? 'wss:' : 'ws:';
    const wsUrl = `${wsProto}//${location.host}/?type=viewer&room=${encodeURIComponent(room)}`;
    const ws = new WebSocket(wsUrl);

    ws.onopen  = () => statusEl.textContent = '연결됨';
    ws.onclose = () => statusEl.textContent = '연결 끊김';
    ws.onerror = () => statusEl.textContent = '오류';

    function safeExec(fn) {
      try {
        const win = iframe.contentWindow;
        if (!win) return;
        fn(win);
      } catch (e) {
        console.warn('safeExec failed', e);
      }
    }

    // ⭐⭐⭐ 여기부터가 문제 해결 핵심 ⭐⭐⭐
    // iframe 내부 페이지가 load될 때마다 링크 클릭을 proxy로 강제 변환
    iframe.addEventListener("load", () => {
      safeExec((win) => {
        const doc = win.document;

        // 모든 <a> 태그 클릭 hijack
        doc.addEventListener("click", (e) => {
          const a = e.target.closest("a");
          if (!a) return;

          const href = a.getAttribute("href");
          if (!href) return;

          // 절대/상대 경로 모두 처리
          const url = new URL(href, win.location.href).href;

          e.preventDefault();
          iframe.src = `/proxy?url=${encodeURIComponent(url)}`;
        });

        // script 내부에서 window.location.href 로 이동할 때도 가로채기
        const origAssign = win.location.assign.bind(win.location);
        win.location.assign = function(u) {
          iframe.src = `/proxy?url=${encodeURIComponent(new URL(u, win.location.href).href)}`;
        };

        const origReplace = win.location.replace.bind(win.location);
        win.location.replace = function(u) {
          iframe.src = `/proxy?url=${encodeURIComponent(new URL(u, win.location.href).href)}`;
        };

        Object.defineProperty(win.location, "href", {
          set(u) {
            iframe.src = `/proxy?url=${encodeURIComponent(new URL(u, win.location.href).href)}`;
          }
        });
      });
    });

    // WebSocket 명령 처리
    ws.onmessage = (ev) => {
      let msg = ev.data;

      try {
        const obj = JSON.parse(msg);
        if (obj.cmd === 'goto') {
          iframe.src = `/proxy?url=${encodeURIComponent(obj.url)}`;
          return;
        }
      } catch (e) {}

      if (msg === 'scrollDown') {
        safeExec(win => win.scrollBy(0, 400));
      } else if (msg === 'scrollUp') {
        safeExec(win => win.scrollBy(0, -400));
      } else if (msg.startsWith('go:')) {
        const url = msg.slice(3);
        iframe.src = `/proxy?url=${encodeURIComponent(url)}`;
      } else if (msg.startsWith('eval:')) {
        const code = msg.slice(5);
        safeExec(win => { try { win.eval(code); } catch (e) {} });
      } else if (msg.startsWith('click:')) {
        const sel = msg.slice(6);
        safeExec(win => {
          const el = win.document.querySelector(sel);
          if (el) el.click();
        });
      } else {
        safeExec(win => { try { win.eval(msg); } catch (e) {} });
      }
    };
  </script>
</body>
</html>
